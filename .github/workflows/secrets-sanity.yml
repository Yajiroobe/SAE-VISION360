name: Secrets Sanity Check

on:
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required secrets exist
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          ok=true
          if [ -z "${GDRIVE_CREDENTIALS}" ]; then echo "Missing secret: GDRIVE_CREDENTIALS"; ok=false; fi
          if [ -z "${GDRIVE_FOLDER_ID}" ]; then echo "Missing secret: GDRIVE_FOLDER_ID"; ok=false; fi
          if [ "$ok" = false ]; then exit 1; fi

      - name: Print safe diagnostics (length + sha256)
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          echo "GDRIVE_FOLDER_ID: length=${#GDRIVE_FOLDER_ID} first4=${GDRIVE_FOLDER_ID:0:4}â€¦ sha256=$(echo -n "$GDRIVE_FOLDER_ID" | sha256sum | cut -d' ' -f1)"
          echo "GDRIVE_CREDENTIALS: length=${#GDRIVE_CREDENTIALS} sha256=$(echo -n "$GDRIVE_CREDENTIALS" | sha256sum | cut -d' ' -f1)"

      - name: Validate service account JSON structure
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          printf '%s' "$GDRIVE_CREDENTIALS" > sa.json
          # Validate JSON and check key presence without printing values
          if ! jq -e . sa.json >/dev/null; then echo "Invalid JSON in GDRIVE_CREDENTIALS"; exit 1; fi
          if ! jq -e 'has("type") and has("client_email") and has("private_key")' sa.json >/dev/null; then 
            echo "Missing required keys in GDRIVE_CREDENTIALS (expected type, client_email, private_key)"; 
            exit 1; 
          fi
          echo "Service account JSON validated (keys present)."
          shred -u sa.json || rm -f sa.json

